rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isTeamMember(teamData) {
      return teamData.members[request.auth.uid] != null;
    }
    
    function hasRole(teamData, role) {
      return teamData.members[request.auth.uid] == role;
    }

    function isOwner(teamData) {
      return hasRole(teamData, 'owner');
    }

    function isCoach(teamData) {
      return hasRole(teamData, 'coach') || isOwner(teamData);
    }

    // 1. Users Collection (Global)
    match /users/{userId} {
      allow read: if isAuthenticated(); // Anyone can read basic profiles (for searching/invites)
      allow write: if request.auth.uid == userId; // User manages own doc
    }

    // 1.1 Artifacts Users Profile (New Path)
    match /artifacts/{appId}/users/{userId}/profile/data {
        allow read: if isAuthenticated();
        allow write: if request.auth.uid == userId;
    }

    // 2. Teams Root
    match /teams/{teamId} {
      // Create: Authenticated users can create teams
      allow create: if isAuthenticated();
      
      // Read
      allow read: if isAuthenticated();

      // Update: Only Owner
      // Security: Validate financial fields if changed? 
      // Prompt says "Validated logic on server or cloud functions" often, but rules can enforce Basic strictness.
      // Owner can change everything for now.
      allow update: if isOwner(resource.data);
      
      // Delete: Only Owner
      allow delete: if isOwner(resource.data);

      // Helper to get team data for subcollections
      function getTeamData() {
        return get(/databases/$(database)/documents/teams/$(teamId)).data;
      }

      // 3. Players Subcollection
      match /players/{playerId} {
        
        // Read: Any team member
        allow read: if isTeamMember(getTeamData());

        // Create/Update: 
        // Owners/Coaches can manage players.
        allow write: if isCoach(getTeamData());
      }

      // 4. Matches Subcollection
      match /matches/{matchId} {
        
        // Read: Any team member
        allow read: if isTeamMember(getTeamData());

        // Write: Owners/Coaches
        allow write: if isCoach(getTeamData());

        // 5. Game Payments Subcollection (nested in matches)
        match /payments/{paymentId} {
            // Read: Team members (transparency?) OR only user?
            // Prompt: "Player: ver pr√≥prio resumo". "Coach/Owner: ver resumo do time".
            // Ideally restrictive. But "Match Details" shows payment status to everyone often?
            // Let's allow team members to read for transparency in amateur teams.
            allow read: if isTeamMember(getTeamData());

            // Write Rules
            // Create: NO ONE (Generated by Server/Admin logic via Transaction/Batch usually run by Admin SDK? 
            // Wait, we generate via Client SDK in this app. So Coach/Owner MUST create).
            allow create: if isCoach(getTeamData());

            // Update:
            // - Player: CANNOT update.
            // - Coach/Owner: Can ONLY update 'status', 'paidAt', 'confirmedBy'. CANNOT update 'amount'.
            allow update: if isCoach(getTeamData()) 
                          && request.resource.data.amount == resource.data.amount
                          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'paidAt', 'confirmedBy']);

            // Delete: NO ONE
            allow delete: if false;         
        }
      }

      // 6. Monthly Payments Subcollection (nested in team)
      match /monthlyPayments/{paymentId} {
          allow read: if isTeamMember(getTeamData());

          // Create: Coach/Owner
          allow create: if isCoach(getTeamData());

          // Update: Coach/Owner ONLY status fields
          allow update: if isCoach(getTeamData()) 
                        && request.resource.data.amount == resource.data.amount
                        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'paidAt', 'confirmedBy']);

          // Delete: NO ONE
          allow delete: if false;
      }

      // 7. Member History (Audit)
      match /memberHistory/{eventId} {
        allow read: if isTeamMember(getTeamData());
        allow create: if isTeamMember(getTeamData());
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // 7. Collection Group for payments (for Dashboard summary?)
    // If we use collectionGroup query, we need rules for it.
    match /{path=**}/payments/{paymentId} {
      allow read: if isTeamMember(get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data);
    }
  }
}
